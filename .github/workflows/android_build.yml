# android_build.yml
name: Android APK Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # 수동 실행 트리거: GitHub 웹에서 직접 실행할 수 있도록 함

jobs:
  build:
    runs-on: ubuntu-22.04 # GitHub Actions에서 안정적인 Ubuntu 22.04 환경 사용

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4 # 프로젝트 코드 가져오기

    - name: Set up Python and Dependencies
      run: |
        echo "--------------------------------------------------------"
        echo "--- Python 및 핵심 Buildozer 의존성 설치 시작 ---"
        echo "--------------------------------------------------------"
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer==1.5.0 cython==0.29.36
        pip install "sh<3.0,>=2" --ignore-installed --no-cache-dir
        pip install appdirs packaging colorama jinja2 toml build
        echo "--------------------------------------------------------"
        echo "--- Python 및 핵심 Buildozer 의존성 설치 완료 ---"
        echo "--------------------------------------------------------"

    - name: Set up Java Development Kit (JDK)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17' # 검증된 JDK 17 버전 사용

    - name: Ensure Python-for-Android is Cloned to Buildozer Working Directory
      run: |
        echo "--------------------------------------------------------"
        echo "--- Python-for-Android (P4A) 클론 및 설치 시작 ---"
        echo "--------------------------------------------------------"
        P4A_DIR="${{ github.workspace }}/.buildozer/android/platform/python-for-android"
        if [ ! -d "${P4A_DIR}" ]; then
          mkdir -p "$(dirname "${P4A_DIR}")"
          git clone --depth 1 https://github.com/kivy/python-for-android.git "${P4A_DIR}"
          echo "python-for-android cloned to: ${P4A_DIR}"
        else
          echo "python-for-android directory already exists, pulling latest master."
          git -C "${P4A_DIR}" fetch origin
          git -C "${P4A_DIR}" checkout master
          git -C "${P4A_DIR}" pull origin master
          echo "python-for-android updated to latest master."
        fi
        pip install -e "${P4A_DIR}"
        echo "Python-for-Android installed in editable mode from: ${P4A_DIR}"
        echo "--------------------------------------------------------"
        echo "--- Python-for-Android (P4A) 클론 및 설치 완료 ---"
        echo "--------------------------------------------------------"

    - name: Force Clean All Buildozer and Kivy Caches
      run: |
        echo "--------------------------------------------------------"
        echo "--- Buildozer 및 Kivy 캐시 강제 삭제 시작 ---"
        echo "--------------------------------------------------------"
        echo "Removing all Buildozer caches and temporary build files for a clean start."
        rm -rf "$HOME/.buildozer" 
        rm -rf "$HOME/.local/share/kivy-android"
        echo "All relevant Buildozer and Kivy caches completely removed."
        echo "--------------------------------------------------------"
        echo "--- Buildozer 및 Kivy 캐시 강제 삭제 완료 ---"
        echo "--------------------------------------------------------"
        
    - name: Install Android SDK Command-line Tools
      run: |
        echo "--------------------------------------------------------"
        echo "--- Android SDK Command-line Tools 설치 시작 ---"
        echo "--------------------------------------------------------"
        BUILD_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "${BUILD_SDK_ROOT}/cmdline-tools"
        curl -L https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip -o android-cmdline-tools.zip
        unzip -q android-cmdline-tools.zip -d "${BUILD_SDK_ROOT}/cmdline-tools"
        mv "${BUILD_SDK_ROOT}/cmdline-tools/cmdline-tools" "${BUILD_SDK_ROOT}/cmdline-tools/latest" 
        echo "--------------------------------------------------------"
        echo "--- Android SDK Command-line Tools 설치 완료 ---"
        echo "--------------------------------------------------------"
      env: 
        ANDROID_SDK_ROOT: "$HOME/.buildozer/android/platform/android-sdk"

    - name: Configure Android SDK Environment Variables
      run: |
        echo "--------------------------------------------------------"
        echo "--- Android SDK 환경 변수 설정 시작 ---"
        echo "--------------------------------------------------------"
        BUILD_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        echo "ANDROID_SDK_ROOT=${BUILD_SDK_ROOT}" >> "$GITHUB_ENV" 
        echo "ANDROID_HOME=${BUILD_SDK_ROOT}" >> "$GITHUB_ENV"
        echo "${BUILD_SDK_ROOT}/cmdline-tools/latest/bin" >> "$GITHUB_PATH" 
        echo "${BUILD_SDK_ROOT}/platform-tools" >> "$GITHUB_PATH"
        mkdir -p "${BUILD_SDK_ROOT}/tools/bin"
        ln -sf "${BUILD_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" "${BUILD_SDK_ROOT}/tools/bin/sdkmanager"
        ln -sf "${BUILD_SDK_ROOT}/cmdline-tools/latest/bin/avdmanager" "${BUILD_SDK_ROOT}/tools/bin/avdmanager"
        echo "--------------------------------------------------------"
        echo "--- Android SDK 환경 변수 설정 완료 ---"
        echo "--------------------------------------------------------"

    - name: Accept Android SDK licenses
      run: |
        echo "--------------------------------------------------------"
        echo "--- Android SDK 라이선스 동의 시작 ---"
        echo "--------------------------------------------------------"
        yes | sdkmanager --licenses --sdk_root="$HOME/.buildozer/android/platform/android-sdk"
        echo "--------------------------------------------------------"
        echo "--- Android SDK 라이선스 동의 완료 ---"
        echo "--------------------------------------------------------"

    - name: Install Required Android Components
      run: |
        echo "--------------------------------------------------------"
        echo "--- 필수 Android SDK, Build-Tools, NDK 설치 시작 ---"
        echo "--------------------------------------------------------"
        sdkmanager \
          "platforms;android-33" \
          "build-tools;33.0.2" \
          "ndk;25.2.9519653" \
          "platform-tools" \
          --sdk_root="$HOME/.buildozer/android/platform/android-sdk"
        echo "--------------------------------------------------------"
        echo "--- 필수 Android SDK, Build-Tools, NDK 설치 완료 ---"
        echo "--------------------------------------------------------"

    - name: Install Autotools dependencies for native libraries
      run: |
        echo "--------------------------------------------------------"
        echo "--- 네이티브 라이브러리 의존성 (Autotools) 설치 시작 ---"
        echo "--------------------------------------------------------"
        sudo apt-get update
        sudo apt-get install -y autoconf automake libtool m4 pkg-config patch build-essential
        echo "--------------------------------------------------------"
        echo "--- 네이티브 라이브러리 의존성 (Autotools) 설치 완료 ---"
        echo "--------------------------------------------------------"

    - name: Build Android APK (Debug)
      run: |
        echo "--------------------------------------------------------"
        echo "--- Buildozer Android APK 빌드 시작 ---"
        echo "--------------------------------------------------------"
        # NDK 경로를 환경 변수에 명시적으로 주입 (buildozer.spec의 ndk_path가 없으므로)
        echo "ANDROID_NDK_HOME=${{ env.ANDROID_SDK_ROOT }}/ndk/25.2.9519653" >> "$GITHUB_ENV"
        echo "ANDROID_NDK_ROOT=${{ env.ANDROID_SDK_ROOT }}/ndk/25.2.9519653" >> "$GITHUB_ENV"
        
        # jnius.c를 찾지 못하는 문제 해결을 위한 PYTHONPATH 조정 시도
        echo "PYTHONPATH=${{ github.workspace }}/.buildozer/android/platform/build-arm64-v8a/build/python-installs/chungahmalpine/arm64-v8a/include/python3.1:${{ env.PYTHONPATH }}" >> "$GITHUB_ENV"

        echo "Forcing clean and rebuild of core recipes (kivy, jnius, android) for initial setup..."
        # P4A 캐시도 완전히 삭제하여 jnius 레시피가 처음부터 다시 준비되도록 유도
        rm -rf "${{ github.workspace }}/.buildozer/android/platform/build-arm64-v8a/build/other_builds/hostpython3"
        rm -rf "${{ github.workspace }}/.buildozer/android/platform/build-arm64-v8a/build/other_builds/jnius"
        rm -rf "${{ github.workspace }}/.buildozer/android/platform/build-arm64-v8a/build/other_builds/python3"

        buildozer android clean --recipes=kivy,jnius,android 
        
        # buildozer.spec의 android.extra_args에 '--allow-minsdk-ndkapi-mismatch'가 포함되어 있으므로 여기서는 제거
        buildozer android debug
        echo "--------------------------------------------------------"
        echo "--- Buildozer Android APK 빌드 완료 (성공/실패 여부 상단 로그 확인) ---"
        echo "--------------------------------------------------------"
      
    - name: Upload APK Artifact
      if: success() # 이전 단계가 성공했을 때만 실행
      run: |
        echo "--------------------------------------------------------"
        echo "--- 빌드된 APK 아티팩트 업로드 시작 ---"
        echo "--------------------------------------------------------"
      uses: actions/upload-artifact@v4
      with:
        name: my-app-apk # 업로드될 아티팩트의 이름
        path: bin/*.apk # 빌드된 APK 파일의 경로 (buildozer가 생성하는 경로)
      # if: success() 는 uses 액션에서 직접 사용하기 어려울 수 있으므로
      # 이전 run 스텝의 if와는 별개로 업로드 자체는 그냥 시도합니다.
      # 다만 업로드 전에 APK 파일 존재 여부를 체크하는 run 스텝을 추가할 수 있습니다.
        