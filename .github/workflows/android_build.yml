# android_build.yml
name: Android APK Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # 수동 실행 트리거: GitHub 웹에서 직접 실행할 수 있도록 함

jobs:
  build:
    runs-on: ubuntu-22.04 # GitHub Actions에서 안정적인 Ubuntu 22.04 환경 사용

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4 # 프로젝트 코드 가져오기

    - name: Set up Python and Dependencies
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' # 검증된 Python 3.10 버전 사용
    
    # --- Buildozer 및 핵심 파이썬 의존성 설치 ---
    - name: Install Buildozer and Core Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer==1.5.0 cython==0.29.36 # Buildozer와 Cython 버전 고정 (매우 중요!)
        
        # P4A가 요구하는 sh<3.0,>=2 조건을 명시적으로 충족시키고 기존 설치된 sh를 강제 교체
        # 기존 sh 버전과 충돌하여 빌드 문제를 일으킬 가능성이 높으므로 강제로 설치합니다.
        pip install "sh<3.0,>=2" --ignore-installed --no-cache-dir # 충돌하는 sh 무시하고 캐시 없이 설치
        
        pip install appdirs packaging colorama jinja2 toml build # 기타 Buildozer 관련 의존성

    - name: Set up Java Development Kit (JDK)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17' # 검증된 JDK 17 버전 사용

    # --- Python-for-Android (P4A) 클론 및 설치 ---
    # P4A를 Buildozer의 작업 공간 내에 직접 클론하고 editable 모드로 설치
    - name: Ensure Python-for-Android is Cloned to Buildozer Working Directory
      run: |
        P4A_DIR="${{ github.workspace }}/.buildozer/android/platform/python-for-android"
        
        if [ ! -d "${P4A_DIR}" ]; then
          mkdir -p "$(dirname "${P4A_DIR}")"
          git clone --depth 1 https://github.com/kivy/python-for-android.git "${P4A_DIR}" # master 브랜치로 클론
          echo "python-for-android cloned to: ${P4A_DIR}"
        else
          echo "python-for-android directory already exists, pulling latest master."
          git -C "${P4A_DIR}" fetch origin
          git -C "${P4A_DIR}" checkout master
          git -C "${P4A_DIR}" pull origin master
          echo "python-for-android updated to latest master."
        fi
        
        pip install -e "${P4A_DIR}" # P4A를 Python 환경에 등록 (editable 모드)
        echo "Python-for-Android installed in editable mode from: ${P4A_DIR}"

    # --- Buildozer 및 Kivy 관련 모든 캐시를 강제로 삭제 (깨끗한 환경 조성) ---
    - name: Force Clean All Buildozer and Kivy Caches
      run: |
        echo "Removing all Buildozer caches and temporary build files for a clean start."
        rm -rf "$HOME/.buildozer" 
        rm -rf "$HOME/.local/share/kivy-android"
        echo "All relevant Buildozer and Kivy caches completely removed."
        
    # --- Android SDK Command-line Tools 설치 ---
    - name: Install Android SDK Command-line Tools
      run: |
        BUILD_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "${BUILD_SDK_ROOT}/cmdline-tools"
        curl -L https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip -o android-cmdline-tools.zip
        unzip -q android-cmdline-tools.zip -d "${BUILD_SDK_ROOT}/cmdline-tools"
        mv "${BUILD_SDK_ROOT}/cmdline-tools/cmdline-tools" "${BUILD_SDK_ROOT}/cmdline-tools/latest" 
      env: 
        ANDROID_SDK_ROOT: "$HOME/.buildozer/android/platform/android-sdk"

    # --- Android SDK Tools를 PATH에 추가 및 환경 변수 설정 ---
    - name: Configure Android SDK Environment Variables
      run: |
        BUILD_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        echo "ANDROID_SDK_ROOT=${BUILD_SDK_ROOT}" >> "$GITHUB_ENV" 
        echo "ANDROID_HOME=${BUILD_SDK_ROOT}" >> "$GITHUB_ENV"
        echo "${BUILD_SDK_ROOT}/cmdline-tools/latest/bin" >> "$GITHUB_PATH" 
        echo "${BUILD_SDK_ROOT}/platform-tools" >> "$GITHUB_PATH"
        mkdir -p "${BUILD_SDK_ROOT}/tools/bin"
        ln -sf "${BUILD_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" "${BUILD_SDK_ROOT}/tools/bin/sdkmanager"
        ln -sf "${BUILD_SDK_ROOT}/cmdline-tools/latest/bin/avdmanager" "${BUILD_SDK_ROOT}/tools/bin/avdmanager" # avdmanager도 추가

    # --- Android SDK 라이선스 동의 ---
    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses --sdk_root="$HOME/.buildozer/android/platform/android-sdk" # SDK_ROOT 명시

    # --- 필수 Android SDK, Build-Tools, NDK 설치 ---
    - name: Install Required Android Components
      run: |
        sdkmanager \
          "platforms;android-33" \
          "build-tools;33.0.2" \
          "ndk;25.2.9519653" \
          "platform-tools" \
          --sdk_root="$HOME/.buildozer/android/platform/android-sdk"

    # --- 네이티브 라이브러리 빌드를 위한 Autotools 의존성 설치 ---
    - name: Install Autotools dependencies for native libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y autoconf automake libtool m4 pkg-config patch

    # --- Build Android APK (Debug) ---
    - name: Build Android APK (Debug)
      run: |
        # Buildozer가 직접적으로 NDK를 다운로드하는 것을 방지하기 위해 Buildozer의
        # NDK 경로 탐색을 위한 환경 변수를 Buildozer에 명시적으로 주입합니다.
        # 이렇게 하면 buildozer.spec의 android.ndk_path 설정 없이도 미리 설치된 NDK를 사용하게 됩니다.
        echo "ANDROID_NDK_HOME=${{ env.ANDROID_SDK_ROOT }}/ndk/25.2.9519653" >> "$GITHUB_ENV"
        echo "ANDROID_NDK_ROOT=${{ env.ANDROID_SDK_ROOT }}/ndk/25.2.9519653" >> "$GITHUB_ENV"
        
        echo "Forcing clean and rebuild of core recipes (kivy, jnius, android) for initial setup..."
        buildozer android clean --recipes=kivy,jnius,android 
        
        buildozer android debug
      
    # --- 빌드된 APK 파일을 아티팩트로 업로드 ---
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: my-app-apk # 업로드될 아티팩트의 이름
        path: bin/*.apk # 빌드된 APK 파일의 경로 (buildozer가 생성하는 경로)